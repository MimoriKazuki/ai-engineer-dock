#!/bin/bash

set -e

PROJECT_DIR="$1"
PR_TITLE="$2"
PR_BODY="$3"

if [ -z "$PROJECT_DIR" ] || [ -z "$PR_TITLE" ]; then
  echo "Usage: create-pr <project-dir> <title> [body]"
  exit 1
fi

cd "$PROJECT_DIR"

# Check if we're in a git repository
if [ ! -d ".git" ]; then
  echo "Error: Not a git repository"
  exit 1
fi

# Create GitHub repository if GITHUB_TOKEN is available
if [ -n "$GITHUB_TOKEN" ]; then
  echo "Creating GitHub repository..."
  
  # Get the project name from directory
  REPO_NAME=$(basename "$PROJECT_DIR")
  
  # Create repository (will fail silently if already exists)
  gh repo create "$REPO_NAME" --public --source=. --remote=origin --push || true
  
  # Create draft PR
  echo "Creating draft pull request..."
  PR_URL=$(gh pr create \
    --title "$PR_TITLE" \
    --body "${PR_BODY:-Generated by AI Engineer Dock}" \
    --draft)
  
  echo "Draft PR created: $PR_URL"
  echo "$PR_URL"
else
  echo "Warning: GITHUB_TOKEN not set, skipping GitHub operations"
  echo "Please set GITHUB_TOKEN to enable PR creation"
fi